<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelvis Test Analysis - DICOM Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .pelvis-test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .results-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ready { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-loading { background: #ffc107; }
        
        .pathology-category {
            background: #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .pathology-category h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        /* Priority-based styling for pathology categories */
        .pathology-category.urgent {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }
        
        .pathology-category.urgent h5 {
            color: #721c24;
        }
        
        .pathology-category.high {
            border-left: 4px solid #fd7e14;
            background: #fff3cd;
        }
        
        .pathology-category.high h5 {
            color: #856404;
        }
        
        .pathology-category.medium {
            border-left: 4px solid #ffc107;
            background: #f8f9fa;
        }
        
        .pathology-category.medium h5 {
            color: #6c757d;
        }
        
        .pathology-category.low {
            border-left: 4px solid #6c757d;
            background: #e9ecef;
        }
        
        .pathology-category.low h5 {
            color: #495057;
        }
        
        .pathology-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .pathology-list li {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        
        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .measurement-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .measurement-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .measurement-label {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .series-info {
            background: #e3f2fd;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .series-info h5 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .confidence-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            transition: width 0.3s ease;
        }

        /* New styles for file upload */
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #f0f0f0;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .upload-area:hover {
            background-color: #e0e0e0;
        }

        .upload-content {
            color: #555;
        }

        .upload-content i {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-progress {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #6c757d);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .file-list {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .file-list h5 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #343a40;
        }

        .file-list ul {
            list-style: none;
            padding: 0;
            margin: 0 0 10px 0;
        }

        .file-list li {
            background: #e9ecef;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-list .file-name {
            flex-grow: 1;
            margin-right: 10px;
        }

        .file-list .file-size {
            font-size: 12px;
            color: #6c757d;
        }

        .file-list .remove-file {
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .file-list .remove-file:hover {
            background-color: #f5c6cb;
        }

        /* New styles for validation errors */
        .validation-errors {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .validation-errors h6 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #856404;
        }

        .error-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            border-left: 4px solid #dc3545;
        }

        .validation-error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .analysis-error {
            background: #fff3cd;
            border-color: #ffeeba;
        }

        /* New styles for upload warning */
        .upload-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            font-weight: bold;
        }

        /* New styles for validation errors section */
        .validation-errors-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="pelvis-test-container">
        <h1>🦴 Pelvis Test Analysis System</h1>
        <p class="lead">Specialized DICOM analysis for pelvis imaging with enhanced pathology detection</p>
        
        <!-- Status Section -->
        <div class="test-section">
            <h3>System Status</h3>
            <div id="status-container">
                <span class="status-indicator status-loading"></span>
                <span>Checking system status...</span>
            </div>
            <button class="test-button" onclick="checkStatus()">Refresh Status</button>
        </div>
        
        <!-- Quick Test Section -->
        <div class="test-section">
            <h3>Quick Pelvis Test</h3>
            <p>Run a quick analysis on the existing pelvis folder to get immediate results.</p>
            <button class="test-button" onclick="runQuickTest()" id="quick-test-btn">
                <span class="loading-spinner" id="quick-test-spinner" style="display: none;"></span>
                Run Quick Test
            </button>
        </div>
        
        <!-- Custom Test Section -->
        <div class="test-section">
            <h4>📁 File Upload</h4>
            <p>Upload individual DICOM files or drag & drop multiple files for analysis</p>
            
            <!-- Warning about pelvis-only files -->
            <div class="upload-warning">
                <strong>⚠️ Important:</strong> This analyzer is designed specifically for <strong>pelvis-related DICOM images</strong>. 
                Files from other body parts (head, chest, abdomen, etc.) will be rejected with an error message. 
                Only upload images of the pelvis, sacrum, coccyx, ilium, ischium, pubis, acetabulum, hip regions, or fistulogram studies.
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-content" id="uploadContent">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Drag & drop DICOM files here</p>
                    <p>or</p>
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> Select Files
                    </button>
                    <input type="file" id="fileInput" multiple accept=".dcm,.dicom" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                <div class="upload-progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="uploadStatus">Uploading files...</p>
                    <div class="progress-details" id="progressDetails" style="display: none;">
                        <p><strong>Current Step:</strong> <span id="currentStep">Initializing...</span></p>
                        <p><strong>Progress:</strong> <span id="progressPercent">0%</span></p>
                        <p><strong>Time Elapsed:</strong> <span id="timeElapsed">0s</span></p>
                    </div>
                </div>
            </div>
            
            <div class="file-list" id="fileList" style="display: none;">
                <h5>Selected Files:</h5>
                <div id="fileItems"></div>
                <button type="button" class="btn btn-success analyze-btn" onclick="uploadFiles()">
                    <i class="fas fa-play"></i> Analyze Files
                </button>
            </div>
        </div>
        
        <div class="test-section">
            <h4>🗂️ Custom Pelvis Test</h4>
            <p><em>Specify a custom folder path for pelvis analysis</em></p>
            <input type="text" id="folder-path" placeholder="Enter folder path (default: pelvis)" 
                   style="width: 300px; padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <button class="test-button" onclick="runCustomTest()" id="custom-test-btn">
                <span class="loading-spinner" id="custom-test-spinner" style="display: none;"></span>
                Run Custom Test
            </button>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="results-container" style="display: none;">
            <h3>Test Results</h3>
            <div id="results-content"></div>
        </div>
        
        <!-- Error Section -->
        <div id="error-container" class="test-section" style="display: none; background: #f8d7da; border-color: #f5c6cb;">
            <h3>Error</h3>
            <div id="error-content"></div>
        </div>
    </div>

    <script>
        // File upload functionality
        let selectedFiles = [];
        
        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#d0e7ff';
                uploadArea.style.borderColor = '#007bff';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#f0f0f0';
                uploadArea.style.borderColor = '#ccc';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#f0f0f0';
                uploadArea.style.borderColor = '#ccc';
                
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });
        });
        
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        }
        
        function handleFiles(files) {
            const dicomFiles = files.filter(file => 
                file.name.toLowerCase().endsWith('.dcm') || 
                file.name.toLowerCase().endsWith('.dicom')
            );
            
            if (dicomFiles.length === 0) {
                alert('Please select DICOM files (.dcm or .dicom)');
                return;
            }
            
            // Check file sizes before adding
            const maxFileSize = 100 * 1024 * 1024; // 100MB per file
            const maxTotalSize = 400 * 1024 * 1024; // 400MB total
            
            let totalSize = 0;
            const oversizedFiles = [];
            
            dicomFiles.forEach(file => {
                totalSize += file.size;
                if (file.size > maxFileSize) {
                    oversizedFiles.push(file.name);
                }
            });
            
            if (oversizedFiles.length > 0) {
                alert(`Warning: The following files are very large and may cause upload issues:\n${oversizedFiles.join('\n')}\n\nConsider compressing these files or uploading them individually.`);
            }
            
            if (totalSize > maxTotalSize) {
                alert(`Warning: Total file size (${(totalSize / (1024 * 1024)).toFixed(1)} MB) is very large. This may take a long time to upload and analyze. Consider uploading fewer files at once.`);
            }
            
            selectedFiles = selectedFiles.concat(dicomFiles);
            displayFileList();
        }
        
        function displayFileList() {
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');
            
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }
            
            fileItems.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                    <span class="remove-file" onclick="removeFile(${index})" title="Remove file">&times;</span>
                `;
                
                fileItems.appendChild(fileItem);
            });
            
            fileList.style.display = 'block';
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }
            
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadContent = document.getElementById('uploadContent');
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');
            const progressDetails = document.getElementById('progressDetails');
            const currentStep = document.getElementById('currentStep');
            const progressPercent = document.getElementById('progressPercent');
            const timeElapsed = document.getElementById('timeElapsed');
            
            uploadContent.style.display = 'none';
            uploadProgress.style.display = 'block';
            progressDetails.style.display = 'block';
            
            // Hide any previous results
            document.getElementById('results-container').style.display = 'none';
            
            const startTime = Date.now();
            let progress = 0;
            
            // Update progress details
            function updateProgress(step, percent, status) {
                currentStep.textContent = step;
                progressPercent.textContent = percent + '%';
                progressFill.style.width = percent + '%';
                uploadStatus.textContent = status;
                
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timeElapsed.textContent = elapsed + 's';
            }
            
            // Simulate upload progress
            updateProgress('Preparing files...', 10, 'Preparing files for upload...');
            await sleep(500);
            
            updateProgress('Uploading files...', 25, 'Uploading files to server...');
            await sleep(800);
            
            updateProgress('Validating files...', 40, 'Validating DICOM files...');
            await sleep(600);
            
            updateProgress('Processing files...', 60, 'Processing uploaded files...');
            await sleep(700);
            
            updateProgress('Analyzing images...', 80, 'Performing DICOM analysis...');
            await sleep(1000);
            
            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });
            
            try {
                updateProgress('Finalizing analysis...', 90, 'Finalizing analysis results...');
                
                const response = await fetch('/api/pelvis/upload-files', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    updateProgress('Complete!', 100, 'Analysis completed successfully!');
                    
                    // Debug: Log the response
                    console.log('Upload response received:', result);
                    console.log('Summary:', result.summary);
                    console.log('Full results:', result.full_results);
                    
                    // Show results after a short delay
                    setTimeout(() => {
                        // Pass both summary and full results to displayResults
                        displayResults(result.summary, result.full_results);
                        resetUploadArea();
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                
                let errorMessage = 'Analysis failed: ' + error.message;
                
                // Provide more specific error messages
                if (error.message.includes('413') || error.message.includes('Request Entity Too Large')) {
                    errorMessage = 'File size too large! The total size of your DICOM files exceeds the server limit. Please try uploading fewer files at once or compress the files if possible.';
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error! Please check your internet connection and try again.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'Upload timeout! The files are taking too long to upload. Please try smaller files or fewer files at once.';
                }
                
                updateProgress('Error', 100, errorMessage);
                progressFill.style.backgroundColor = '#dc3545';
                
                // Show error details
                setTimeout(() => {
                    alert(errorMessage + '\n\nPlease check the console for more details.');
                }, 1000);
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function resetUploadArea() {
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadContent = document.getElementById('uploadContent');
            const fileList = document.getElementById('fileList');
            const progressDetails = document.getElementById('progressDetails');
            
            uploadProgress.style.display = 'none';
            uploadContent.style.display = 'block';
            fileList.style.display = 'none';
            progressDetails.style.display = 'none';
            selectedFiles = [];
            
            // Reset progress bar
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = '0%';
            progressFill.style.backgroundColor = '';
        }

        // Global variables
        let currentResults = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
        });
        
        // Check system status
        async function checkStatus() {
            try {
                const statusContainer = document.getElementById('status-container');
                statusContainer.innerHTML = '<span class="status-indicator status-loading"></span><span>Checking system status...</span>';
                
                const response = await fetch('/api/pelvis/status');
                const data = await response.json();
                
                if (data.success) {
                    const statusHtml = `
                        <span class="status-indicator status-ready"></span>
                        <span><strong>System Ready</strong></span><br>
                        <small>Pelvis folder: ${data.pelvis_folder_available ? '✅ Available' : '❌ Not Found'}</small><br>
                        <small>Available series: ${data.total_series}</small><br>
                        <small>Analyzer: ${data.analyzer_status}</small>
                    `;
                    statusContainer.innerHTML = statusHtml;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                const statusHtml = `
                    <span class="status-indicator status-error"></span>
                    <span><strong>System Error</strong></span><br>
                    <small>${error.message}</small>
                `;
                document.getElementById('status-container').innerHTML = statusHtml;
            }
        }
        
        // Run quick test
        async function runQuickTest() {
            try {
                const btn = document.getElementById('quick-test-btn');
                const spinner = document.getElementById('quick-test-spinner');
                
                btn.disabled = true;
                spinner.style.display = 'inline-block';
                hideResults();
                hideError();
                
                const response = await fetch('/api/pelvis/quick-test');
                const data = await response.json();
                
                if (data.success) {
                    currentResults = data.full_results;
                    displayResults(data.summary, data.full_results);
                } else {
                    throw new Error(data.error || 'Test failed');
                }
            } catch (error) {
                showError(error.message);
            } finally {
                const btn = document.getElementById('quick-test-btn');
                const spinner = document.getElementById('quick-test-spinner');
                btn.disabled = false;
                spinner.style.display = 'none';
            }
        }
        
        // Run custom test
        async function runCustomTest() {
            try {
                const folderPath = document.getElementById('folder-path').value.trim() || 'pelvis';
                const btn = document.getElementById('custom-test-btn');
                const spinner = document.getElementById('custom-test-spinner');
                
                btn.disabled = true;
                spinner.style.display = 'inline-block';
                hideResults();
                hideError();
                
                const response = await fetch('/api/pelvis/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ folder_path: folderPath })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentResults = data.results;
                    displayResults(data.results, data.results);
                } else {
                    throw new Error(data.error || 'Test failed');
                }
            } catch (error) {
                showError(error.message);
            } finally {
                const btn = document.getElementById('custom-test-btn');
                const spinner = document.getElementById('custom-test-spinner');
                btn.disabled = false;
                spinner.style.display = 'none';
            }
        }
        
        // Display results
        function displayResults(summary, fullResults) {
            console.log('displayResults called with:', { summary, fullResults });
            
            const container = document.getElementById('results-container');
            const content = document.getElementById('results-content');
            
            // Show the results container
            container.style.display = 'block';
            
            // Add clear summary message at the top
            let html = '';
            
            if (summary.successful_analyses === 0 && summary.total_files > 0) {
                html += `
                    <div class="test-section validation-errors-section">
                        <h4>🚫 No Valid Files to Analyze</h4>
                        <p><strong>All ${summary.total_files} uploaded files were rejected</strong> because they are not pelvis images.</p>
                        <p>The system correctly identified these as brain MRI files and prevented incorrect analysis.</p>
                    </div>
                `;
            }
            
            html += `
                <div class="test-section">
                    <h4>📊 Analysis Summary</h4>
                    <div class="measurement-grid">
                        <div class="measurement-item">
                            <div class="measurement-value">${summary.total_files || 0}</div>
                            <div class="measurement-label">Total Files</div>
                        </div>
                        <div class="measurement-item">
                            <div class="measurement-value">${summary.successful_analyses || 0}</div>
                            <div class="measurement-label">Successful Analyses</div>
                        </div>
                        <div class="measurement-item">
                            <div class="measurement-value">${summary.key_pathologies_count || summary.total_pathologies || 0}</div>
                            <div class="measurement-label">Key Pathologies</div>
                        </div>
                        <div class="measurement-item">
                            <div class="measurement-value">${summary.total_landmarks || 0}</div>
                            <div class="measurement-label">Anatomical Landmarks</div>
                        </div>
                    </div>
                    
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${(summary.confidence || 0) * 100}%"></div>
                    </div>
                    <small>Confidence: ${((summary.confidence || 0) * 100).toFixed(1)}%</small>
                </div>
            `;
            
            // Key Pathology Summary
            if (fullResults.pathology_summary && Object.keys(fullResults.pathology_summary).length > 0) {
                html += '<div class="test-section"><h4>🔍 Key Pathological Findings</h4>';
                html += '<p><em>Showing only clinically significant findings prioritized by urgency</em></p>';
                
                for (const [category, pathologies] of Object.entries(fullResults.pathology_summary)) {
                    if (pathologies.length > 0) {
                        const categoryIcon = getCategoryIcon(category);
                        const categoryPriority = getCategoryPriority(category);
                        
                        html += `
                            <div class="pathology-category ${categoryPriority}">
                                <h5>${categoryIcon} ${category.charAt(0).toUpperCase() + category.slice(1)} (${categoryPriority.toUpperCase()})</h5>
                                <ul class="pathology-list">
                                    ${pathologies.map(p => {
                                        const frequency = fullResults.overall_findings?.pathology_frequency?.[p] || 1;
                                        const frequencyText = frequency > 1 ? ` (${frequency} files)` : '';
                                        return `<li>${p}${frequencyText}</li>`;
                                    }).join('')}
                                </ul>
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
            }
            
            // Recommendations
            if (summary.recommendations && summary.recommendations.length > 0) {
                html += `
                    <div class="test-section">
                        <h4>💡 Clinical Recommendations</h4>
                        <ul>
                            ${summary.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Display validation errors and failed files prominently
            if (fullResults.series_results) {
                for (const [seriesName, seriesData] of Object.entries(fullResults.series_results)) {
                    if (seriesData.failed_count > 0) {
                        html += '<div class="test-section validation-errors-section">';
                        html += '<h4>❌ File Validation Results</h4>';
                        html += `<p><strong>${seriesData.failed_count} files were rejected</strong> because they are not pelvis images.</p>`;
                        
                        // Show some example error messages
                        if (seriesData.files) {
                            const failedFiles = Object.values(seriesData.files).filter(file => file.error);
                            if (failedFiles.length > 0) {
                                html += '<div class="validation-errors">';
                                html += '<h6>⚠️ Validation Errors (Sample):</h6>';
                                // Show first 5 errors as examples
                                failedFiles.slice(0, 5).forEach(file => {
                                    if (file.error === 'validation_failed') {
                                        html += `<div class="error-item validation-error">
                                            <strong>${file.filename}:</strong> ${file.error_message}
                                        </div>`;
                                    }
                                });
                                if (failedFiles.length > 5) {
                                    html += `<div class="error-item">
                                        <em>... and ${failedFiles.length - 5} more files with similar validation errors</em>
                                    </div>`;
                                }
                                html += '</div>';
                            }
                        }
                        
                        html += '<div class="upload-warning">';
                        html += '<strong>💡 What This Means:</strong> Your files were detected as brain MRI images, not pelvis images. ';
                        html += 'The system correctly rejected them to prevent incorrect analysis. ';
                        html += 'Please upload only DICOM files of the pelvis, sacrum, coccyx, ilium, ischium, pubis, acetabulum, hip regions, or fistulogram studies.';
                        html += '</div>';
                        html += '</div>';
                    }
                }
            }
            
            // Series Information
            if (fullResults.series_results) {
                html += '<div class="test-section"><h4>📁 Series Analysis</h4>';
                
                for (const [seriesName, seriesData] of Object.entries(fullResults.series_results)) {
                    html += `
                        <div class="series-info">
                            <h5>${seriesName}</h5>
                            <p><strong>Files:</strong> ${seriesData.file_count} | 
                               <strong>Successful:</strong> ${seriesData.successful_count} | 
                               <strong>Confidence:</strong> ${((seriesData.confidence_score || 0) * 100).toFixed(1)}%</p>
                            <p><strong>Anatomical Landmarks:</strong> ${seriesData.anatomical_landmarks?.join(', ') || 'None'}</p>
                            <p><strong>Pathologies:</strong> ${formatPathologies(seriesData.pathologies)}</p>
                        </div>
                    `;
                    
                    // Show validation errors and failed files
                    if (seriesData.files) {
                        const failedFiles = Object.values(seriesData.files).filter(file => file.error);
                        if (failedFiles.length > 0) {
                            html += '<div class="validation-errors">';
                            html += '<h6>⚠️ Validation Errors & Failed Files:</h6>';
                            failedFiles.forEach(file => {
                                if (file.error === 'validation_failed') {
                                    html += `<div class="error-item validation-error">
                                        <strong>${file.filename}:</strong> ${file.error_message}
                                    </div>`;
                                } else if (file.error === 'analysis_failed') {
                                    html += `<div class="error-item analysis-error">
                                        <strong>${file.filename}:</strong> Analysis failed - ${file.error_message}
                                    </div>`;
                                }
                            });
                            html += '</div>';
                        }
                    }
                }
                
                html += '</div>';
            }
            
            // Download Results Button
            if (fullResults.analysis_date) {
                html += `
                    <div class="test-section">
                        <h4>💾 Download Results</h4>
                        <button class="test-button" onclick="downloadResults()">Download JSON Results</button>
                        <button class="test-button" onclick="downloadSummary()">Download Summary Report</button>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }
        
        // Show error
        function showError(message) {
            const container = document.getElementById('error-container');
            const content = document.getElementById('error-content');
            
            content.innerHTML = `<p><strong>Error:</strong> ${message}</p>`;
            container.style.display = 'block';
        }
        
        // Hide results
        function hideResults() {
            document.getElementById('results-container').style.display = 'none';
        }
        
        // Hide error
        function hideError() {
            document.getElementById('error-container').style.display = 'none';
        }
        
        // Download results as JSON
        function downloadResults() {
            if (!currentResults) return;
            
            const dataStr = JSON.stringify(currentResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pelvis_analysis_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            link.click();
        }
        
        // Helper function to clean and format pathologies
        function formatPathologies(pathologies) {
            if (!pathologies || !Array.isArray(pathologies)) return 'None';
            
            // Remove duplicates and sort
            const uniquePathologies = [...new Set(pathologies)];
            
            // Format with frequency if available
            if (currentResults?.overall_findings?.pathology_frequency) {
                return uniquePathologies.map(p => {
                    const frequency = currentResults.overall_findings.pathology_frequency[p] || 1;
                    return frequency > 1 ? `${p} (${frequency} files)` : p;
                }).join(', ');
            }
            
            return uniquePathologies.join(', ');
        }
        
        // Helper functions for pathology categories
        function getCategoryIcon(category) {
            const icons = {
                'fractures': '🦴',
                'fistulogram': '🔗',
                'tumors': '🩺',
                'vascular': '💉',
                'inflammatory': '🔥',
                'degenerative': '📉',
                'other': '⚠️'
            };
            return icons[category] || '🔍';
        }
        
        function getCategoryPriority(category) {
            const priorities = {
                'fractures': 'urgent',
                'fistulogram': 'high',
                'tumors': 'high',
                'vascular': 'high',
                'inflammatory': 'medium',
                'degenerative': 'low',
                'other': 'low'
            };
            return priorities[category] || 'low';
        }
        
        // Download summary report
        function downloadSummary() {
            if (!currentResults) return;
            
            const summary = `
Pelvis Analysis Summary Report
Generated: ${new Date().toLocaleString()}

ANALYSIS OVERVIEW:
- Total Files: ${currentResults.total_files || 0}
- Successful Analyses: ${currentResults.successful_analyses || 0}
- Total Pathologies: ${currentResults.overall_findings?.total_pathologies || 0}
- Total Landmarks: ${currentResults.overall_findings?.total_anatomical_landmarks || 0}
- Overall Confidence: ${((currentResults.overall_findings?.overall_confidence || 0) * 100).toFixed(1)}%

KEY PATHOLOGICAL FINDINGS (Prioritized by Clinical Significance):
${Object.entries(currentResults.pathology_summary || {}).map(([category, pathologies]) => {
    const priority = getCategoryPriority(category);
    const categoryName = category === 'fistulogram' ? 'FISTULOGRAM FINDINGS' : category.toUpperCase();
    return `${categoryName} (${priority.toUpperCase()} PRIORITY):\n${pathologies.map(p => `  - ${p}`).join('\n')}`;
}).join('\n\n')}

CLINICAL RECOMMENDATIONS:
${(currentResults.recommendations || []).map(r => `- ${r}`).join('\n')}

SERIES ANALYSIS:
${Object.entries(currentResults.series_results || {}).map(([name, data]) => 
    `${name}:\n  Files: ${data.file_count}, Success: ${data.successful_count}, Confidence: ${((data.confidence_score || 0) * 100).toFixed(1)}%`
).join('\n\n')}
            `;
            
            const dataBlob = new Blob([summary], {type: 'text/plain'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pelvis_summary_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            link.click();
        }
    </script>
</body>
</html>